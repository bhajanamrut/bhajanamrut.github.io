<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhajan Events </title>
</head>
<style>
    body {
        margin: 0;
        background: #ffc58f;
        font-family: Arial, sans-serif;
    }

    h2.month-heading {
        margin: 0px 30px;
        font-size: 5vw;
        color: black;
    }

    h1.title {
        margin: 2px 20px;
        font-size: 4vw;
        color: black;
    }


    .event-card {
        position: relative;
        /* width: 100%; */
        aspect-ratio: 14 / 9;
        /* background: url(images/bg.jpg) no-repeat center / cover; 
        background: url(images/bg.jpg) center / contain no-repeat;*/
        color: green;
        overflow: hidden;
        margin: 10px 10px;
        background: url(images/bg.jpg) center / cover no-repeat;
    }

    /* Dark overlay for better text contrast */
    .event-card::before {
        content: "";
        position: absolute;
        inset: 0;
        /*background: rgba(0,0,0,0.4);*/
    }

    /* Common text style */
    .event-text {
        position: absolute;
        transform: translate(-50%, -50%);
        white-space: nowrap;
        z-index: 1;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
    }


    .event-num {
        left: 3%;
        top: 5%;
        font-size: 2vw;
        font-weight: bold;
        color: DarkBlue;
        position: absolute;
        transform: translate(-50%, -50%);
        white-space: nowrap;
        z-index: 1;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    }

    .event-date {
        position: absolute;
        transform: translate(-50%, -50%);
        left: 50%;
        top: 32%;
        font-size: 3.4vw;
        font-weight: bold;
        color: DarkBlue;
        
    }



    .event-occasion {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 39%;   
        left: 50%;
        font-size: 2.7vw;
        font-weight: bold;
        text-align: center;
        color: darkgreen;
        width: max-content;
        
    }

    .event-time {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 56%;
        left: 50%;
        font-size: 2vw;
        font-weight: bold;
        color: DarkBlue;
    }



   .event-venue {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 84%;
        left: 50%;
        font-size: 2.9vw;
        font-weight: bold;
        text-align: center;
        color: purple;
        width: max-content;
    }
    
    .event-place {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 90%;
        left: 50%;
        font-size: 2.7vw;
        font-weight: bold;
        text-align: center;
        color: darkcyan;
        width: max-content;
    }

    .contact-name {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 96%;
        left: 36%;
        font-size: 2vw;
        font-weight: bold;
        text-align: center;
        color: orangered;
        width: max-content;
    }

    .contact-phone {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 96%;
        left: 64%;
        font-size: 2vw;
        font-weight: bold;
        text-align: center;
        color: orangered;
        width: max-content;
    }

    .share-btn {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 92%;
        left: 95%;
        width: clamp(35px, 6vw, 50px);
        height: clamp(35px, 6vw, 50px);
        background-color: #25D366;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s ease-in-out;
        border: green;
    }

    .share-btn svg {
        width: 90%;   /* scales relative to button */
        height: 90%;  /* keeps aspect ratio */
    }

/*
    .share-btn {
        position: absolute;
        transform: translate(-50%, -50%);
        top: 96%;
        left: 92%;
        width: 50px;
        height: 50px;
        background-color: #25D366; 
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        
        cursor: pointer;
        transition: transform 0.2s ease-in-out;
    }
    
    .share-btn svg {
        width: 40px;
        height: 40px;
    }

    
    .share-btn:hover {
        transform: scale(1.1);
    }
    */
    
    /* @media (max-width: 600px) {
        .event-date { font-size: 4vw; }
        .event-occasion { font-size: 5vw; }
        .event-venue { font-size: 3.5vw; }
        .event-host { font-size: 3vw; }
    } */
</style>
</head>
<body>

<h1 class="title">निस्वार्थ भजन संध्या सूची</h1>
<div class="event-container" id="eventContainer"></div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        var bhajanEvents;
        
        function onLoad() {
          
            fetchEventsAndDisplay();
        }

        window.addEventListener('load', onLoad, false);

        const propmap = {
                'STATUS': 0,
                'NUM': 1,
                'DATE': 2,
                'DAY': 3,
                'TIME': 4,
                'OCCASION': 5,
                'VENUE': 6,
                'PLACE': 7,
                'LANDMARK': 8,
                'MAP': 9,
                'HOSTNAME': 10,
                'HOSTPHONE': 11
            };

        function filter(rows){
            const colIndex = 0;                  // Column "L" = 12th column, index 11 (0-based)

            const filteredRows = rows.slice(1).filter(row => {
            const value = row[colIndex] ? row[colIndex].toLowerCase().trim() : "";
            return value === "confirmed";
            });

            return filteredRows;
        }
        
        function fetchEventsAndDisplay() {
            const sheetId = '1BFfMs1439CClB5YfNGov_GeUYbESKHq7feKa1ONk2W0'; // Replace with your actual sheet ID
            const sheetName = 'Sheet1!A2:L1000'; // Replace with the name of your sheet
            const apiKey = 'AIzaSyBTkT9f1ceMamAPhKhpMkUItgVIsH4RJuU'; // Optional, can be omitted if not using an API key

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;
            //const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}`;
            console.log(url);
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Sheet Data:', data.values); // Log the values in the sheet
                    const rows = data.values || [];
                    bhajanEvents = filter(rows);
                    console.log('Filtered Data:', bhajanEvents); // Log the values in the sheet
                    display();
                    scrollToCurrentMonth();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function display(){
            const container = document.getElementById("eventContainer");

            // Sort by date
            bhajanEvents.sort((a, b) => new Date(a[propmap.DATE]) - new Date(b[propmap.DATE]));

            let currentMonthYear = "";
            bhajanEvents.forEach(evt => {

                const dateObj = new Date(evt[propmap.DATE]);
                const monthYear = dateObj.toLocaleString("en-US", { month: "short", year: "numeric" });

                if (monthYear !== currentMonthYear) {
                    currentMonthYear = monthYear;
                    const heading = document.createElement("h2");
                    heading.className = "month-heading";
                    heading.textContent = monthYear;
                    container.appendChild(heading);
                }

                const card = document.createElement("div");
                card.className = "event-card";

                card.innerHTML = `
                    <div class="event-content">
                        <div class="event-num">${evt[propmap.NUM]}</div>
                        <div class="event-date">${new Date(evt[propmap.DATE]).toDateString()}</div>
                        <div class="event-occasion">${evt[propmap.OCCASION]}</div>
                        <div class="event-time">${evt[propmap.TIME]}</div>
                        <div class="event-venue">${evt[propmap.VENUE]}</div>
                        <div class="event-place">${evt[propmap.PLACE]}</div>
                        <div class="contact-name">Krishna Purohit</div>
                        <div class="contact-phone">+919390484899</div>
                        
                    </div>
                `;

                // Create share button separately

                const shareBtn = document.createElement("button");
                //shareBtn.textContent = "Share";
                shareBtn.className = "share-btn";

                shareBtn.innerHTML = `
                    <svg viewBox="0 0 20 20">
                        <path d="m8.5 4c.27614 0 .5.22386.5.5 0 .24545778-.17687704.4496079-.41012499.49194425l-.08987501.00805575h-3c-.77969882 0-1.420449.59488554-1.49313345 1.35553954l-.00686655.14446046v8c0 .7796706.59488554 1.4204457 1.35553954 1.4931332l.14446046.0068668h8c.7796706 0 1.4204457-.5949121 1.4931332-1.3555442l.0068668-.1444558v-1c0-.2761.2239-.5.5-.5.2454222 0 .4496.1769086.4919429.4101355l.0080571.0898645v1c0 1.325472-1.0315469 2.4100378-2.3356256 2.4946823l-.1643744.0053177h-8c-1.3254816 0-2.41003853-1.0315469-2.49468231-2.3356256l-.00531769-.1643744v-8c0-1.3254816 1.03153766-2.41003853 2.33562452-2.49468231l.16437548-.00531769zm3.8776-.42218c0-.44778533.4618631-.70274151.8163008-.51603855l.0740992.04685855.0617.05301 4.4971 4.42118c.1865778.18340444.2224.46564543.1074667.68700565l-.0501667.07984435-.0572.06544-4.4971 4.42258c-.31528.3100533-.8146258.1449156-.9285862-.2465427l-.0183138-.0872573-.0053-.0823v-2.0955l-.2577.0232c-.2489.0266-.4963.0654-.7423.1164-1.53378.3183-3.01312 1.1122-4.44499 2.3907-.38943.3478-.99194.019-.92789-.5063.486252-3.98795475 2.48231514-6.23076163 5.8838529-6.60251607l.2644271-.02490393.2246-.01511zm1 1.03322v2.03152l-1.1513.07744c-1.5737.12605-2.73395.67426-3.5631 1.56852-.66903.72156-1.17827 1.72888-1.47646 3.06698 1.41552133-1.0608267 2.9105751-1.7256288 4.4876574-1.95751891l.3476026-.04395109 1.3556-.1218v2.15597l3.4462-3.38915z" fill="white"/>
                    </svg>`;

                // Bind click event
                shareBtn.addEventListener("click", (e) => {
                    e.stopPropagation(); // prevent bubbling from interfering
                    console.log("Share button clicked for:", evt[propmap.OCCASION]);
                    captureAndShare(card, evt);
                });

                card.appendChild(shareBtn);

                container.appendChild(card);
                
            });
        }

        function scrollToCurrentMonth() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const currentDay = today.getDate();

            const cards = document.querySelectorAll(".event-card");
            let targetCard = null;

            for (let card of cards) {
                const dateElement = card.querySelector(".event-date");
                if (dateElement) {
                    const cardDate = new Date(dateElement.textContent);
                    if (cardDate.getMonth() === currentMonth && cardDate.getFullYear() === currentYear) {
                        if(cardDate.getDate() <= currentDay) {
                            targetCard = card;
                        }
                        else {
                            break;    
                        }
                    }
                    
                }
            }

            if (targetCard) {
                targetCard.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }


        function captureAndShare(card, evt) {
			// Convert table to canvas
			html2canvas(card, {
                        ignoreElements: (element) => {
                            return element.classList.contains("share-btn");
                        }}
                    ).then(canvas => {
                        // Convert canvas to a data URL for the image
                        let imgData = canvas.toDataURL('image/png');

                        // Create an anchor element to trigger the download
                        let a = document.createElement('a');
                        a.href = imgData;
                        a.download = `भजन संध्या #${evt[propmap.NUM]} - ${new Date(evt[propmap.DATE]).toDateString()}.png`;  // Name of the image file to be saved

                        // Trigger the download by simulating a click
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        let encodedMessage = buildWhatsAppMessage(evt);
                        let whatsappLink = `https://wa.me/?text=${encodedMessage}`;
                        // Open WhatsApp share link
                        window.open(whatsappLink, '_blank');
                    
                    });
		}

        function buildWhatsAppMessage(evt) {
            let parts = [];

            if (evt[propmap.NUM]) parts.push(`*निःस्वार्थ भजन सेवा #${evt[propmap.NUM]}*`);
            if (evt[propmap.DATE]) parts.push(`Date: ${new Date(evt[propmap.DATE]).toDateString()}`);
            if (evt[propmap.TIME]) parts.push(`Time: ${evt[propmap.TIME]}`);
            if (evt[propmap.OCCASION]) parts.push(`Occasion: ${evt[propmap.OCCASION]}`);
            parts.push(` `);

            if (evt[propmap.VENUE]) parts.push(`Venue: ${evt[propmap.VENUE]}`);
            if (evt[propmap.PLACE]) parts.push(`Place: ${evt[propmap.PLACE]}`);
            if (evt[propmap.LANDMARK]) parts.push(`Landmark: ${evt[propmap.LANDMARK]}`);
            parts.push(` `);

            if (evt[propmap.HOSTNAME]) parts.push(`Host: ${evt[propmap.HOSTNAME]}`);
            if (evt[propmap.HOSTPHONE]) parts.push(`Host Phone: ${evt[propmap.HOSTPHONE]}`);
            parts.push(` `);

            if (evt[propmap.MAP]) parts.push(`Map: ${evt[propmap.MAP]}`);
            parts.push(` `);

            parts.push(`Contact: Krishna Purohit +919390484899`);
            parts.push(` `);

            parts.push(`Bhajans: https://bhajanamrut.github.io/`);

            // Join with newline, then encode for WhatsApp
            const msg = parts.join("\n");
            return encodeURIComponent(msg);
        }

        
        async function captureAndShare2(card) {
            //const card = document.querySelector('.event-card'); // pick the card you want

            // Capture as canvas
            const canvas = await html2canvas(card, { scale: 2 }); // higher scale = sharper image

            // Convert canvas to Blob
            canvas.toBlob(async (blob) => {
                if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'event.png', { type: 'image/png' })] })) {
                    // Create file object for Web Share API
                    const file = new File([blob], 'event.png', { type: 'image/png' });

                    try {
                        await navigator.share({
                            files: [file],
                            title: 'Event Details',
                            text: 'Check out this event!'
                        });
                        console.log('Shared successfully!');
                    } catch (err) {
                        console.error('Share failed:', err);
                    }
                } else {
                    // Fallback for browsers without Web Share API
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'event.png';
                    link.click();
                    URL.revokeObjectURL(url);
                    alert("Image downloaded. You can now send it via WhatsApp.");
                }
            });
        }
    </script>
</body>
</html>



